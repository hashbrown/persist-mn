---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import CategoryFilter from '../../components/CategoryFilter.astro';
import BusinessDetailCard from '../../components/BusinessDetailCard.astro';
import { getCategorySlug } from '../../utils/categories';

export const getStaticPaths = (async () => {
  const businesses = await getCollection('businesses');

  return businesses.map((business) => ({
    params: { slug: business.slug },
    props: { business },
  }));
}) satisfies GetStaticPaths;

const { business } = Astro.props;
const categorySlug = getCategorySlug(business.data.category);
---

<Layout title={`${business.data.displayName} - Persist MN`}>
  <Header searchCategorySlug={categorySlug} />
  <CategoryFilter currentCategory={categorySlug} />

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <a
        href={`/category/${categorySlug}`}
        data-default-back-href={`/category/${categorySlug}`}
        class="text-sm font-medium text-blue-600 hover:text-blue-700"
      >
        ← Back to {business.data.category}
      </a>
    </div>

    <BusinessDetailCard business={business} />
  </main>
</Layout>

<script is:inline>
  // If the user arrived from a paginated/category page via search, preserve that in the Back link.
  const params = new URLSearchParams(window.location.search)
  const from = params.get('from')
  if (from) {
    const backLink = document.querySelector('a[data-default-back-href]')
    if (backLink instanceof HTMLAnchorElement) {
      backLink.href = from
      backLink.textContent = '← Back'
    }
  }
</script>

